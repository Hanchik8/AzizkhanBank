server:
  port: ${SERVER_PORT:8080}
  shutdown: graceful

spring:
  application:
    name: ${SPRING_APPLICATION_NAME:account-service}
  threads:
    virtual:
      enabled: true
  config:
    import: "optional:sm://"
  cloud:
    gcp:
      project-id: ${GCP_PROJECT_ID}
      secretmanager:
        enabled: true
  datasource:
    url: ${SPRING_DATASOURCE_URL:jdbc:postgresql://127.0.0.1:5432/core_ledger}
    username: ${SPRING_DATASOURCE_USERNAME:banking_app}
    password: ${sm://banking-prod-db-password}
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 3000
      validation-timeout: 1000
      data-source-properties:
        reWriteBatchedInserts: true
  jpa:
    open-in-view: false
    hibernate:
      ddl-auto: validate
    properties:
      hibernate:
        jdbc:
          time_zone: UTC
        format_sql: false
  liquibase:
    enabled: ${SPRING_LIQUIBASE_ENABLED:false}
  data:
    redis:
      host: ${SPRING_DATA_REDIS_HOST:127.0.0.1}
      port: ${SPRING_DATA_REDIS_PORT:6379}
      ssl:
        enabled: ${SPRING_DATA_REDIS_SSL_ENABLED:${SPRING_DATA_REDIS_SSL:true}}
      password: ${sm://banking-prod-redis-auth}
  kafka:
    bootstrap-servers: ${SPRING_KAFKA_BOOTSTRAP_SERVERS:localhost:9092}
    producer:
      acks: all
      transaction-id-prefix: ${SPRING_KAFKA_PRODUCER_TRANSACTION_ID_PREFIX:account-service-tx-}
      retries: 10
      properties:
        enable.idempotence: true
        max.in.flight.requests.per.connection: 5
        delivery.timeout.ms: 120000
        request.timeout.ms: 30000
    properties:
      security.protocol: ${SPRING_KAFKA_SECURITY_PROTOCOL:PLAINTEXT}
  security:
    oauth2:
      resourceserver:
        jwt:
          secret-value: ${JWT_SECRET:change-this-secret-key-to-at-least-32-bytes-long}

banking:
  kafka:
    topics:
      account-events: ${BANKING_KAFKA_TOPICS_ACCOUNT_EVENTS:account.events.v1}
  outbox:
    poll-interval: ${BANKING_OUTBOX_POLL_INTERVAL:2000}
    initial-delay: ${BANKING_OUTBOX_INITIAL_DELAY:5000}
    batch-size: ${BANKING_OUTBOX_BATCH_SIZE:100}
    publish-timeout-seconds: ${BANKING_OUTBOX_PUBLISH_TIMEOUT_SECONDS:10}
  redis:
    lock:
      host: ${SPRING_DATA_REDIS_HOST:127.0.0.1}
      port: ${SPRING_DATA_REDIS_PORT:6379}
      ssl: ${BANKING_REDIS_LOCK_SSL:${SPRING_DATA_REDIS_SSL_ENABLED:${SPRING_DATA_REDIS_SSL:true}}}
      password: ${sm://banking-prod-redis-auth}
      wait-timeout: ${BANKING_REDIS_LOCK_WAIT_TIMEOUT:5s}
      lease-timeout: ${BANKING_REDIS_LOCK_LEASE_TIMEOUT:15s}

management:
  endpoints:
    web:
      exposure:
        include: health,info,prometheus
  endpoint:
    health:
      probes:
        enabled: true
      show-details: never
  tracing:
    enabled: true
    sampling:
      probability: ${TRACING_SAMPLING_PROBABILITY:1.0}
  otlp:
    tracing:
      endpoint: ${MANAGEMENT_OTLP_TRACING_ENDPOINT:http://otel-collector.observability.svc.cluster.local:4318/v1/traces}
  metrics:
    tags:
      application: ${spring.application.name}
      environment: ${ENVIRONMENT:prod}

logging:
  pattern:
    correlation: "[traceId=%X{traceId:-},spanId=%X{spanId:-}] "

# Workload Identity is assumed in GKE:
# - No service account keys in containers
# - Spring Cloud GCP reads ADC from GKE metadata server
